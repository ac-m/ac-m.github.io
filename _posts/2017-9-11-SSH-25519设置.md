---
layout: post
title: SSH 25519设置
---

## 生成CA密钥
```bash
mkdir -p ~/ssh_ca && cd ~/ssh_ca
ssh-keygen -t ed25519 -N "" -C "CA key" -f ca_key
```
其中  
  -t为密钥类型  
  -N为私钥保护密码  
  -C为注释  
  -f为输出私钥文件名，输出公钥文件名为私钥文件名加".pub"  


## 生成客户端用户证书
```bash
ssh-keygen -t ed25519 -N "" -C "ed25519 user key"
#接着，把~/.ssh/id_ed25519.pub复制到CA所在主机
#principal可设为在任何主机中不存在的用户user1、user2
ssh-keygen -s ~/ssh_ca/ca_key -I "ed25519 user certificate" -n user1,user2 ~/.ssh/id_ed25519.pub
#接着，把id_ed25519-cert.pub复制到客户端
chmod go-rwx ~/.ssh
```
第一行，生成私钥~/.ssh/id_ed25519、公钥~/.ssh/id_ed25519.pub  
第三行，用私钥ca_key签名公钥id_ed25519.pub得到证书id_ed25519-cert.pub  
principal可设为在任何主机中不存在的虚拟用户user1、user2  
-I指明密钥标识，当服务器认证用户证书时会记录到日志。 



## 设置客户端~/.ssh/config

~/.ssh/config可不存在，默认会使用下面两个文件进行认证  
~/.ssh/id_ed25519  
~/.ssh/id_ed25519-cert.pub  

以下~/.ssh/config设置为调试目的
```bash
touch ~/.ssh/config
chmod go-rwx ~/.ssh/config
```

```bash
KexAlgorithms curve25519-sha256@libssh.org
PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ssh-ed25519
CertificateFile ~/.ssh/id_ed25519-cert.pub
IdentityFile ~/.ssh/id_ed25519
```


## 设置客户端~/.ssh/known_hosts
```bash
echo "@cert-authority * $(cat ~/ssh_ca/ca_key.pub)" >>~/.ssh/known_hosts
```


## 生成服务器主机证书
```bash
sudo ssh-keygen -t ed25519 -N "" -C "ed25519 server host key" -f /etc/ssh/ssh_host_ed25519_key
#接着，/etc/ssh/ssh_host_ed25519_key.pub复制到CA所在主机, scp fromABC toDEF
ssh-keygen -s ~/ssh_ca/ca_key -I "ed25519 server host certificate" -h ./ssh_host_ed25519_key.pub
#接着，把ssh_host_ed25519_key-cert.pub和ca_key.pub复制到服务器, scp fromABC toDEF
```
第一行，生成私钥/etc/ssh/ssh_host_ed25519_key、公钥/etc/ssh/ssh_host_ed25519_key.pub  
第三行，用私钥ca_key签名公钥ssh_host_ed25519_key.pub得到证书ssh_host_ed25519_key-cert.pub，  
其中-h表示这是主机证书而非用户证书。  


## 设置服务器/etc/ssh/sshd_config
```bash
HostKey /etc/ssh/ssh_host_ed25519_key
HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub
HostKeyAlgorithms ssh-ed25519
KexAlgorithms curve25519-sha256@libssh.org
PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com
PasswordAuthentication no
ChallengeResponseAuthentication no

TrustedUserCAKeys /etc/ssh/ca_key.pub
AuthorizedPrincipalsFile /etc/ssh/auth_principals
```

## 编辑Principals文件
编辑/etc/ssh/auth_principals  
添加允许的principals，每行一个，例如user1  
```bash
user1
from="192.168.1.1" user2
from="192.168.1.2" user3
```
这里user1是虚拟用户，可以不是server上用户。  
from表示限定IP访问。
