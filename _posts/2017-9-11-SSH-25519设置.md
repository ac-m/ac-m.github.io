---
layout: post
title: SSH 25519设置
---

## 生成CA密钥
```bash
mkdir -p ~/ssh_ca && cd ~/ssh_ca
ssh-keygen -t ed25519 -N "" -C "CA key" -f ca_key
```
其中  
  -t为密钥类型  
  -N为私钥保护密码  
  -C为注释  
  -f为输出私钥文件名，输出公钥文件名为私钥文件名加".pub"  


## 生成客户端用户证书
```bash
ssh-keygen -t ed25519 -N "" -C "ed25519 user key"
#接着，把~/.ssh/id_ed25519.pub复制到CA所在主机
ssh-keygen -s ~/ssh_ca/ca_key -I "ed25519 user certificate" ~/.ssh/id_ed25519.pub
#接着，把id_ed25519-cert.pub复制到客户端
```
第一行，生成私钥~/.ssh/id_ed25519、公钥~/.ssh/id_ed25519.pub  
第三行，用私钥ca_key签名公钥id_ed25519.pub得到证书id_ed25519-cert.pub  
-I指明密钥标识，当服务器认证用户证书时会记录到日志。  



## 设置客户端~/.ssh/config
```bash
KexAlgorithms curve25519-sha256@libssh.org
PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ssh-ed25519
CertificateFile ~/.ssh/id_ed25519-cert.pub
IdentityFile ~/.ssh/id_ed25519
```
KexAlgorithms、PubkeyAcceptedKeyTypes可以使用默认值，只在服务器端限制特定值。
```bash
chmod go-rwx ~/.ssh/config
```


## 设置客户端~/.ssh/known_hosts
```bash
echo "@cert-authority * $(cat ~/ssh_ca/ca_key.pub)" >>~/.ssh/known_hosts
```


## 生成服务器主机证书
```bash
sudo ssh-keygen -t ed25519 -N "" -C "ed25519 server host key" -f /etc/ssh/ssh_host_ed25519_key
#接着，/etc/ssh/ssh_host_ed25519_key.pub复制到CA所在主机, scp fromABC toDEF
ssh-keygen -s ~/ssh_ca/ca_key -I "ed25519 server host certificate" -h ./ssh_host_ed25519_key.pub
#接着，把ssh_host_ed25519_key-cert.pub和ca_key.pub复制到服务器, scp fromABC toDEF
```
第一行，生成私钥/etc/ssh/ssh_host_ed25519_key、公钥/etc/ssh/ssh_host_ed25519_key.pub  
第三行，用私钥ca_key签名公钥ssh_host_ed25519_key.pub得到证书ssh_host_ed25519_key-cert.pub，  
其中-h表示这是主机证书而非用户证书。  


## 设置服务器/etc/ssh/sshd_config
```bash
HostKey /etc/ssh/ssh_host_ed25519_key
HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub
HostKeyAlgorithms ssh-ed25519
KexAlgorithms curve25519-sha256@libssh.org
PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com
```

```bash
echo "cert-authority $(cat ca_key.pub)" >>~/.ssh/authorized_keys
```
