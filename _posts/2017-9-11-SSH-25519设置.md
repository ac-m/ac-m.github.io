---
layout: post
title: SSH 25519设置
---

## 生成CA密钥
```bash
mkdir -p ~/ssh_ca && cd ~/ssh_ca
ssh-keygen -t ed25519 -N "" -C "CA key" -f ca_key
```
其中  
  -t为密钥类型  
  -N为私钥保护密码  
  -C为注释  
  -f为输出私钥文件名，输出公钥文件名为私钥文件名加".pub"  


## 生成客户端用户证书
```bash
ssh-keygen -t ed25519 -N "" -C "userA key" -f ./user_key
#接着，把user_key.pub复制到CA所在主机
ssh-keygen -s ca_key -I "userA certificate" ./user_key.pub
#接着，把user_key-cert.pub复制到客户端
```
第一行，生成私钥user_key、公钥user_key.pub  
第三行，用私钥ca_key签名公钥user_key.pub得到证书user_key-cert.pub  
-I指明密钥标识，当服务器认证用户证书时会记录到日志。


## 设置客户端~/.ssh/config
```bash
#KexAlgorithms curve25519-sha256@libssh.org
#PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ssh-ed25519
CertificateFile ~/user_key-cert.pub
IdentityFile ~/user_key
```
KexAlgorithms、PubkeyAcceptedKeyTypes可以使用默认值，只在服务器端限制特定值。


## 设置客户端~/.ssh/known_hosts
```bash
echo "@cert-authority * $(cat ca_key.pub)" >>~/.ssh/known_hosts
```


## 生成服务器主机证书
```bash
ssh-keygen -t ed25519 -N "" -C "server host key" -f ./host_key
#接着，把host_key.pub复制到CA所在主机
ssh-keygen -s ca_key -I "server host certificate" -h ./host_key.pub
#接着，把host_key-cert.pub复制到服务器
```
第一行，生成私钥host_key、公钥host_key.pub  
第三行，用私钥ca_key签名公钥host_key.pub得到证书host_key-cert.pub，  
其中-h表示这是主机证书而非用户证书。  


## 设置服务器/etc/ssh/sshd_config
```bash
TrustedUserCAKeys /etc/ssh/ca_key.pub
HostKey /etc/ssh/ssh_host_ed25519_key
HostCertificate /etc/ssh/host_key-cert.pub
HostKeyAlgorithms ssh-ed25519-cert-v01@openssh.com
KexAlgorithms curve25519-sha256@libssh.org
PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com
```
